:scrollbar:
:toc2:

=  Trilo Backup and Recovery Lab

== Introduction

In this lab we will be installing the Trilio backup operator and restoring virtual machines on Openshift. 

=== Installing the Operator
. Search the Operator hub for the Trilio for kubernetes. 
+
image::Trilio/operator.PNG[link=self, window=blank, width=100%]
+
. Keep all the default options. The operator will be installed in the trilio-system namespace.  All pods related to Trilio will run in this namespace as to not interfere with security restrictions and quota restrictions. To enalbe the Trilio Backups menu options in the left navigation pane in the OpenShift console, select *Enable* under _Console Plugin_. 
+
[NOTE]
The console plugin is a light version of the full Trilio UI.  The full UI is also available using a route.  
+  
image::Trilio/operator2.PNG[link=self, window=blank, width=100%]
+  
. Click on Refresh Web console when the operator is installed
+  
image::Trilio/operator3.PNG[link=self, window=blank, width=100%]
+  
. If everything is ok, you should see the Trilio Backups option in the left navigation pane.  On the Details pane, click “Create instance”, this will start the Trilio pods.  
+  
image::Trilio/operator4.PNG[link=self, window=blank, width=100%]
+  
. On the Create TrilioVaultManager page, accept the defaults, click on the *Create* icon.  
+  
image::Trilio/operator5.PNG[link=self, window=blank, width=100%]
+  
. After a few minutes, the Trilio Vault Manager instance should be in a *Deployed* status. 
+  
image::Trilio/operator6.PNG[link=self, window=blank, width=100%]


=== Change the Ingresss  
In this Lab the OCP cluster has a NAT forward for external access. This causes the apps deployed to default to the internal example.com domain.  This must be updated so they can be routed correctly to the internal pods running in your cluster. 

. On the left navagation pane, expand *Networking*, select *Ingresses*.  
+
image::Trilio/networkingIngresses.PNG[link=self, window=blank, width=100%]
+
. Select *k8s-triliovault* from the list and click on the *YAML* menu option in the top horizontal menu bar.  
+
image::Trilio/k8s-triliovault.PNG[link=self, window=blank, width=100%]
+
. Modify the `spec.rules.host` parameter.  The host name should be trilio-system-apps._XXXX_.dynamic.redhatworkshops.io, where the _XXXX_ is your specific workshop instance name.  Click *Save*.  
+
image::Trilio/rules.host.PNG[link=self, window=blank, width=100%]
+
[NOTE] 
The notification this resource is managed by TVM triliovault-manager will be displayd.  Click *Save* again.  You can verify your changes by scrolling back down to the .spec.rules.host to verify your changes were saved.
+
image::Trilio/k8s-triliovaultIngress.PNG[link=self, window=blank, width=100%]
+
. In the left navigation pane, expand *Networking* and select *Routes*. There will be four routes listed in the trilio-system project.   Click the route that ends with the backslash '/'.  This will launch the Trilio UI login screen in a new tab.
+
image::Trilio/login.PNG[link=self, window=blank, width=100%]
+
. Click the Sign-in via OpenShift icon; login using the admin credentials to the Kubernetes cluster.
+


=== Apply license

Click here to open the menu, and apply the license:

image::Trilio/lic1.PNG[]

```
xxx
```
image::Trilio/lic2.PNG[]

At this point the operator has been configured and is ready to start accepting backups. 

=== Setup s3 backup 

Trilio requires either an S3 bucket or an NFS export to store the backup data.  For the lab, we will use an internal bucket but for production backups it is highly recommended to use an external bucket.

. Expand *Storage* in the left navigation pane, select *Object Storage*, and select *Object Bucket Claims* from the top horizontal menu.
+
image::Trilio/objectbucketclaim.png[link=self, window=blank, width=100%]
+
. Click the *Create ObjectBucketClaim* icon.  Input the following and click *Create*.
* ObjectBucketClaim Name: trilio-bucket
* StorageClass: openshift-storage.noobaa.io
* BucketClass: noobaa-default-bucket-class  
+
image::Trilio/targetCreateNew.png[link=self, window=blank, width=100%]


=== Backup Targets

Configure Trilio to use the new S3 bucket created in the previous step.

. Under `CLUSTER MANAGEMENT`, select the *tvk-instance* from the list of Clusters.  
+
image::Trilio/tvkinstance.png[]
+
. In the left navigation pane, select *Targets*.  On the far right, click the *Create New* icon.
+
image::Trilio/targetCreateNew.png[]
+
. On the _Create Target_ pop-up window, enter the following information:
* Namespace
* Threshold Capacity
* Vendor Details - select ObjectStore 
* Vendor - Other
* Bucket Name - from the _OpenShift Console GUI_, select *Storage*, *Object Storage*, *ObjectBucketClaims*, select the *trilio-bucket*.  Scroll to the bottom and use the copy features for the _Bucket Name_ field and paste it to the _Bucket Name_ field.
* Region - us-east-1
* URL - from the OCP GUI, select *Networking*, *Routes*, filter on _S3_. Copy the S3 route to the clipboard and paste the value to the _URL_ field.
* Skip Certificate Verification - enabled
* Object store credentials - from the _OpenShift Console GUI_, select *Storage*, *Object Storage*, *ObjectBucketClaims*, select the *trilio-bucket*.  Scroll to the bottom and use the copy features for the AWS Access Key and Secret Key to copy and paste them in the appropriate fields in the _Create Secret_ dialog window.
* Enable Browsing - enabled
+
image::Trilio/createtarget.png[]
+
image::Trilio/createsecret.png[]
+
. On the pop-up window, enter a name for the new target and click the *Create Target* icon.
+
image::Trilio/triliobuckettarget.png[]
+
. The target will initially be in an `InProgress` state.  After a few minutes, the target should be in an `Available` state.  Scroll to the right to see the _Status_ field.
+
image::Trilio/availableStatus.png[]


=== NameSpace Backups 

In the _Virtual Machine Management_ lab exercise, we had created the _vmexamples_ namespace along with virtual machine fedora-01.  In the _Storage Management_ lab we created the fedora-02 virtual machine.  And if you completed the _Migrating Virtual Machines_ lab, you also will have the winweb0[12] and database virtual machines. For the _Trilio Data Protection_ lab, please apply all instructions to the vmexamples namespace.

We are going to protect everything inside, apps and VMs. BTW, they can be running https://github.com/kubevirt/kubevirt/blob/main/docs/freeze.md. If it is a  VM backup then Trilio internally runs a custom hook job which uses virt-freezer to freeze/quiesce the VM and once data snapshotting is done Trilio unfreeze/unquiesce the VM. Trilio also checks if qemu-guest-agent is running or not in the VM.

We will be using the vmexamples project. 
```
Project: vmexamples
Virtual Machines: 
  - database
  - winweb01
  - winweb02

```
Go to the Trilio UI, and create a new Backup Plan with this info…and click Next, Next and “skip & create”. 

image::Trilio/backup4.PNG[]

Finally we will run the create backup giving the backup a name and creating it. 

image::Trilio/backup5.PNG[]

Trilio has both the dedicated GUI console and a new OCP plugin to check on the backup progress. For this lab we will contiune to use the dedicated GUI. 

Finally we can check the list of backups and if we view the details under the metadata summary the Virtual Machines will be listed. 

image::Trilio/backup6.PNG[]

=== Restoring Virtual Machines

The first example is how to restore a full namespace. Namespace backup/recovery is fairly common within kubernetes and does have some differences from the traditional virtual machine backup/restore. 

==== Restoring a namespace

image::Trilio/restore1.PNG[]

1. Click on Restores
2. Click “Create Restore”
3. Select the namespace you want to restore and click Next:

Then select what namespace you want to restore to, it can be same or different. If you want to use the same one, remove the VMs first:

image::Trilio/restore2.PNG[]

==== Restore from the Trilio UI

Trilio is stateless, from the point of view that if one cluster is inaccessible, apps and VMs can be restored from the backup target itself, to any cluster with access to the backup target.

In order to accomplish this, you would need to enable that same S3 bucket ( or NFS) on the cluster where you want to migrate / DR your VM

After it is configured in the destination cluster, you need to “enable target browsing”

image::Trilio/restore3.PNG[]

And then you can launch the target browser, a unique feature of Trilio, where you can “browse” any backup target, S3 or NFS, see backups from different clusters, etc...

image::Trilio/restore4.PNG[]

From this point we can chose what resources to restore to either the current or a differnt cluster. You can expand the metadata to view the virtual machine and other details related to the restore.    

image::Trilio/restore5.PNG[]

==== Restore a VM to a different namespace

For this section create a project and namespace with the following details:

```
Project: fedora-example
Create a Virtual machine with the Fedora image as the base
Follow the Instructions above to create a backup of the namespace 
```

In this example we will restore a VM to a different namesapce. In the Backup Plan that holds the fedora backup, click restore:

Choose a name for the restore, and choose a namespace to restore, and click Next. I created a new namespace named fedora-restore for the demo. Click Next and create the new restore. 

image::Trilio/restore6.PNG[]

After the restore finishes the namespace along with the VM should appear on the cluster. 

image::Trilio/restore7.PNG[]
